!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three")):"function"==typeof define&&define.amd?define(["three"],t):i.physijs=t(i.THREE)}(this,function(i){"use strict";function t(){return q++}function s(t,s,o,r){var a,p,h;return t instanceof i.Geometry?(p=t,a=new i.Mesh(p,s),h=o):(a=t,s instanceof i.Geometry?(p=s,h=o):(p=a.geometry,h=s)),a.rotationAutoUpdate=!1,a.matrixAutoUpdate=!1,a.physics=new e(a,p,h,r),a.clone=n.bind(a,a.clone),a}function e(s,n,o,r){o=o||{},this.three_object=s,this.geometry=n,this.getShapeDefinition=r,this.linear_velocity=new i.Vector3,this.angular_velocity=new i.Vector3,this.linear_factor=new i.Vector3(1,1,1),this.angular_factor=new i.Vector3(1,1,1),this._={id:t(),mass:o.mass||1/0,restitution:o.restitution||.1,friction:o.friction||.5,linear_damping:o.linear_damping||0,angular_damping:o.angular_damping||0,collision_groups:o.collision_groups||0,collision_mask:o.collision_mask||0,position:new i.Vector3,quaternion:new i.Quaternion,linear_velocity:new i.Vector3,angular_velocity:new i.Vector3,linear_factor:new i.Vector3(1,1,1),angular_factor:new i.Vector3(1,1,1)},this.clone=function(i){var t=new e(i,n,o,r);return t.mass=this.mass,t.restitution=this.restitution,t.friction=this.friction,t.linear_damping=this.linear_damping,t.angular_damping=this.angular_damping,t.collision_groups=this.collision_groups,t.collision_mask=this.collision_mask,t.linear_velocity.copy(this.linear_velocity),t.angular_velocity.copy(this.angular_velocity),t.linear_factor.copy(this.linear_factor),t.angular_factor.copy(this.angular_factor),t}}function n(){var i=Array.prototype.slice.call(arguments),t=i.shift(),s=t.apply(this,i);return s.physics=this.physics.clone(s),s}function o(i,t,e){return s.call(this,i,t,e,r)}function r(i){return i.computeBoundingBox(),{body_type:W.BOX,width:i.boundingBox.max.x,height:i.boundingBox.max.y,depth:i.boundingBox.max.z}}function a(i,t,e){return s.call(this,i,t,e,p)}function p(i){return i.computeBoundingBox(),{body_type:W.CONE,radius:i.boundingBox.max.x,height:i.boundingBox.max.y}}function h(i,t,e){return s.call(this,i,t,e,c)}function c(i){var t=i.vertices.reduce(function(i,t){return i.push(t.x,t.y,t.z),i},[]);return{body_type:W.CONVEX,vertices:t}}function _(i,t,e){return s.call(this,i,t,e,y)}function y(i){return i.computeBoundingBox(),{body_type:W.CYLINDER,radius:i.boundingBox.max.x,height:i.boundingBox.max.y}}function l(i,t,e){return s.call(this,i,t,e,d)}function d(i){return i.computeBoundingBox(),{body_type:W.PLANE,width:i.boundingBox.max.x,height:i.boundingBox.max.y}}function u(i,t,e){return s.call(this,i,t,e,g)}function g(i){return i.computeBoundingSphere(),{body_type:W.SPHERE,radius:i.boundingSphere.radius}}function f(i,t,e){return s.call(this,i,t,e,I)}function I(i){var t=i.vertices.reduce(function(i,t){return i.push(t.x,t.y,t.z),i},[]),s=i.faces.reduce(function(i,t){return i.push(t.a,t.b,t.c),i},[]);return{body_type:W.TRIANGLE,vertices:t,faces:s}}function R(){this.constraint_id=t(),this.scene=null}function b(t,s,e,n,o){R.call(this),this.body_a=t,this.hinge_axis=s,this.point_a=e,this.body_b=n,this.point_b=o,this.physics={active:!0,factor:1,breaking_threshold:0,last_impulse:new i.Vector3,limit:{enabled:!1,lower:null,upper:null},motor:{enabled:!1,torque:null,max_speed:null}}}function m(i,t){if(null==t)throw new Error("Physijs: attempted to create rigid body without specifying physics details");return i.physics instanceof e?i.physics.getShapeDefinition=O.bind(null,i,i.physics.getShapeDefinition):i.physics=new e(i,null,t,O.bind(null,i)),i.rotationAutoUpdate=!1,i.matrixAutoUpdate=!1,i.clone=n.bind(i,i.clone),i}function O(t,s){var n=[],o=new i.Vector3,r=new i.Quaternion;t.updateMatrix(),t.updateMatrixWorld(!0);var a=(new i.Matrix4).getInverse(t.matrixWorld),p=new i.Matrix4;return t.traverse(function(i){if(i.updateMatrix(),i.updateMatrixWorld(!0),i.physics instanceof e){var h;null!=s?h=s(i.physics.geometry):t!==i&&(h=i.physics.getShapeDefinition(i.physics.geometry)),null!=h&&(p.copy(i.matrixWorld).multiply(a),o.setFromMatrixPosition(p),r.setFromRotationMatrix(p),n.push({position:{x:o.x,y:o.y,z:o.z},quaternion:{x:r._x,y:r._y,z:r._z,w:r._w},shape_definition:h}))}}),{body_type:W.COMPOUND,shapes:n}}function D(i){var t=i.physics.getShapeDefinition(i.physics.geometry);return{body_id:i.physics._.id,shape_definition:t,mass:i.physics._.mass,restitution:i.physics._.restitution,friction:i.physics._.friction,linear_damping:i.physics._.linear_damping,angular_damping:i.physics._.angular_damping,collision_groups:i.physics._.collision_groups,collision_mask:i.physics._.collision_mask}}function E(t,s){i.Scene.call(this),this.physijs={handlers:{},handleMessage:j.bind(this),is_stepping:!1,id_body_map:{},id_constraint_map:{},onStep:null,initializeWorker:T.bind(this),processWorldReport:A.bind(this),processCollisionReport:B.bind(this),postMessage:x.bind(this),postReport:v.bind(this),setRigidBodyMass:N.bind(this),setRigidBodyRestitution:G.bind(this),setRigidBodyFriction:L.bind(this),setRigidBodyLinearDamping:M.bind(this),setRigidBodyAngularDamping:C.bind(this),setRigidBodyCollisionGroups:Y.bind(this),setRigidBodyCollisionMask:w.bind(this),setRigidBodyTransform:P.bind(this),setRigidBodyLinearVelocity:z.bind(this),setRigidBodyAngularVelocity:V.bind(this),setRigidBodyLinearFactor:U.bind(this),setRigidBodyAngularFactor:k.bind(this),inflight_raytraces:{},processRaytraceResults:F.bind(this)},this.physics={raytrace:S.bind(this)},this.physijs.initializeWorker(t,s)}function S(i,s){var e=t();this.physijs.postMessage(X.RAYTRACE,{raytrace_id:e,rays:i.map(function(i){return{start:{x:i.start.x,y:i.start.y,z:i.start.z},end:{x:i.end.x,y:i.end.y,z:i.end.z}}})}),this.physijs.inflight_raytraces[e]=s}function j(i,t){this.physijs.handlers[i]=t}function T(i,t){this.physijs.worker=new Worker(i),this.physijs.worker.addEventListener("message",function(i){var t,s,e=i.data;if(e instanceof Float32Array?(t=e[0],s=e):(e=e||{},t=e.type,s=e.parameters),!this.physijs.handlers.hasOwnProperty(t))throw new Error("Physijs scene received unknown message type: "+t);this.physijs.handlers[t](s)}.bind(this)),this.physijs.handleMessage(X.REPORTS.WORLD,this.physijs.processWorldReport),this.physijs.handleMessage(X.REPORTS.COLLISIONS,this.physijs.processCollisionReport),this.physijs.handleMessage(X.RAYTRACE_RESULTS,this.physijs.processRaytraceResults),this.physijs.postMessage(X.INITIALIZE,t||{})}function A(i){for(var t=i[1],s=i[2],e=0;s>e;e++){var n=3+30*e,o=i[n++],r=this.physijs.id_body_map[o];null!=r&&(r.matrix.set(i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++]),r.position.copy(r.physics._.position.set(i[n++],i[n++],i[n++])),r.quaternion.copy(r.physics._.quaternion.set(i[n++],i[n++],i[n++],i[n++])),r.physics.linear_velocity.copy(r.physics._.linear_velocity.set(i[n++],i[n++],i[n++])),r.physics.angular_velocity.copy(r.physics._.angular_velocity.set(i[n++],i[n++],i[n++])))}if(this.physijs.postReport(i),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var a=this.physijs.onStep;this.physijs.onStep=null,a.call(this,t)}}function B(i){for(var t=i[1],s=0;t>s;s+=15){var e=s+2,n=this.physijs.id_body_map[i[e+0]],o=this.physijs.id_body_map[i[e+1]];null!=n&&null!=o&&(K.set(i[e+2],i[e+3],i[e+4]),Z.set(i[e+5],i[e+6],i[e+7]),Q.set(i[e+8],i[e+9],i[e+10]),J.set(i[e+11],i[e+12],i[e+13]),n.dispatchEvent({type:"physics.newContact",other_body:o,contact_point:K,contact_normal:Z,relative_linear_velocity:Q,relative_angular_velocity:J,penetration_depth:i[e+14]}),o.dispatchEvent({type:"physics.newContact",other_body:n,contact_point:K,contact_normal:Z,relative_linear_velocity:Q,relative_angular_velocity:J,penetration_depth:i[e+14]}))}this.physijs.postReport(i)}function x(i,t){this.physijs.worker.postMessage({type:i,parameters:t})}function v(i){this.physijs.worker.postMessage(i,[i.buffer])}function N(i){this.physijs.postMessage(X.SET_RIGIDBODY_MASS,{body_id:i._.id,mass:i._.mass})}function G(i){this.physijs.postMessage(X.SET_RIGIDBODY_RESTITUTION,{body_id:i._.id,restitution:i._.restitution})}function L(i){this.physijs.postMessage(X.SET_RIGIDBODY_FRICTION,{body_id:i._.id,friction:i._.friction})}function M(i){this.physijs.postMessage(X.SET_RIGIDBODY_LINEAR_DAMPING,{body_id:i._.id,damping:i._.linear_damping})}function C(i){this.physijs.postMessage(X.SET_RIGIDBODY_ANGULAR_DAMPING,{body_id:i._.id,damping:i._.angular_damping})}function Y(i){this.physijs.postMessage(X.SET_RIGIDBODY_COLLISION_GROUPS,{body_id:i._.id,collision_groups:i._.collision_groups})}function w(i){this.physijs.postMessage(X.SET_RIGIDBODY_COLLISION_MASK,{body_id:i._.id,collision_mask:i._.collision_mask})}function P(i){this.physijs.postMessage(X.SET_RIGIDBODY_TRANSFORM,{body_id:i.physics._.id,position:{x:i.position.x,y:i.position.y,z:i.position.z},rotation:{x:i.quaternion.x,y:i.quaternion.y,z:i.quaternion.z,w:i.quaternion.w}})}function z(i){this.physijs.postMessage(X.SET_RIGIDBODY_LINEAR_VELOCITY,{body_id:i.physics._.id,velocity:{x:i.physics.linear_velocity.x,y:i.physics.linear_velocity.y,z:i.physics.linear_velocity.z}})}function V(i){this.physijs.postMessage(X.SET_RIGIDBODY_ANGULAR_VELOCITY,{body_id:i.physics._.id,velocity:{x:i.physics.angular_velocity.x,y:i.physics.angular_velocity.y,z:i.physics.angular_velocity.z}})}function U(i){this.physijs.postMessage(X.SET_RIGIDBODY_LINEAR_FACTOR,{body_id:i.physics._.id,factor:{x:i.physics.linear_factor.x,y:i.physics.linear_factor.y,z:i.physics.linear_factor.z}})}function k(i){this.physijs.postMessage(X.SET_RIGIDBODY_ANGULAR_FACTOR,{body_id:i.physics._.id,factor:{x:i.physics.angular_factor.x,y:i.physics.angular_factor.y,z:i.physics.angular_factor.z}})}function F(t){var s=this.physijs.inflight_raytraces[t.raytrace_id],e=this;s(t.results.map(function(t){return t.map(function(t){return{body:e.physijs.id_body_map[t.body_id],point:new i.Vector3(t.point.x,t.point.y,t.point.z),normal:new i.Vector3(t.normal.x,t.normal.y,t.normal.z)}})},e))}i="default"in i?i["default"]:i;var q=0;Object.defineProperty(e.prototype,"mass",{get:function(){return this._.mass},set:function(i){this._.mass=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyMass(this)}}),Object.defineProperty(e.prototype,"restitution",{get:function(){return this._.restitution},set:function(i){this._.restitution=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyRestitution(this)}}),Object.defineProperty(e.prototype,"friction",{get:function(){return this._.friction},set:function(i){this._.friction=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyFriction(this)}}),Object.defineProperty(e.prototype,"linear_damping",{get:function(){return this._.linear_damping},set:function(i){this._.linear_damping=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyLinearDamping(this)}}),Object.defineProperty(e.prototype,"angular_damping",{get:function(){return this._.angular_damping},set:function(i){this._.angular_damping=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyAngularDamping(this)}}),Object.defineProperty(e.prototype,"collision_groups",{get:function(){return this._.collision_groups},set:function(i){this._.collision_groups=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyCollisionGroups(this)}}),Object.defineProperty(e.prototype,"collision_mask",{get:function(){return this._.collision_mask},set:function(i){this._.collision_mask=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyCollisionMask(this)}});var W={BOX:"BOX",COMPOUND:"COMPOUND",CONE:"CONE",CONVEX:"CONVEX",CYLINDER:"CYLINDER",PLANE:"PLANE",SPHERE:"SPHERE",TRIANGLE:"TRIANGLE"},H={HINGE:"HINGE"};b.prototype=Object.create(R.prototype),b.prototype.constructor=b,b.prototype.getConstraintDefinition=function(){return{constraint_type:H.HINGE,constraint_id:this.constraint_id,body_a_id:this.body_a.physics._.id,hinge_axis:{x:this.hinge_axis.x,y:this.hinge_axis.y,z:this.hinge_axis.z},point_a:{x:this.point_a.x,y:this.point_a.y,z:this.point_a.z},body_b_id:null==this.body_b?null:this.body_b.physics._.id,point_b:null==this.body_b?null:{x:this.point_b.x,y:this.point_b.y,z:this.point_b.z},active:this.physics.active,factor:this.physics.factor,breaking_threshold:this.physics.breaking_threshold,limit:{enabled:this.physics.limit.enabled,lower:this.physics.limit.lower,upper:this.physics.limit.upper},motor:{enabled:this.physics.motor.enabled,torque:this.physics.motor.torque,max_speed:this.physics.motor.max_speed}}},b.prototype.setActive=function(i){this.physics.active=i},b.prototype.setLimit=function(i,t){this.physics.limit.enabled=null!=i||null!=t,this.physics.limit.lower=i,this.physics.limit.upper=t},b.prototype.setMotor=function(i,t){this.physics.motor.enabled=null!=i||null!=t,this.physics.motor.torque=i,this.physics.motor.max_speed=t};var X={REPORTS:{WORLD:0,COLLISIONS:1},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",REMOVE_RIGIDBODY:"REMOVE_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_RESTITUTION:"SET_RIGIDBODY_RESTITUTION",SET_RIGIDBODY_FRICTION:"SET_RIGIDBODY_FRICTION",SET_RIGIDBODY_LINEAR_DAMPING:"SET_RIGIDBODY_LINEAR_DAMPING",SET_RIGIDBODY_ANGULAR_DAMPING:"SET_RIGIDBODY_ANGULAR_DAMPING",SET_RIGIDBODY_COLLISION_GROUPS:"SET_RIGIDBODY_COLLISION_GROUPS",SET_RIGIDBODY_COLLISION_MASK:"SET_RIGIDBODY_COLLISION_MASK",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",SET_RIGIDBODY_LINEAR_VELOCITY:"SET_RIGIDBODY_LINEAR_VELOCITY",SET_RIGIDBODY_ANGULAR_VELOCITY:"SET_RIGIDBODY_ANGULAR_VELOCITY",SET_RIGIDBODY_LINEAR_FACTOR:"SET_RIGIDBODY_LINEAR_FACTOR",SET_RIGIDBODY_ANGULAR_FACTOR:"SET_RIGIDBODY_ANGULAR_FACTOR",STEP_SIMULATION:"STEP_SIMULATION",RAYTRACE:"RAYTRACE",RAYTRACE_RESULTS:"RAYTRACE_RESULTS",ADD_CONSTRAINT:"ADD_CONSTRAINT"},K=new i.Vector3,Z=new i.Vector3,Q=new i.Vector3,J=new i.Vector3;E.prototype=Object.create(i.Scene.prototype),E.prototype.constructor=E,E.prototype.add=function(t){if(t instanceof R){t.scene=this;var s=t.getConstraintDefinition();return this.physijs.id_constraint_map[s.constraint_id]=t,this.physijs.setRigidBodyTransform(t.body_a),null!=t.body_b&&this.physijs.setRigidBodyTransform(t.body_b),void this.physijs.postMessage(X.ADD_CONSTRAINT,s)}if(i.Scene.prototype.add.call(this,t),t.physics instanceof e){var n=D(t);this.physijs.id_body_map[n.body_id]=t,this.physijs.postMessage(X.ADD_RIGIDBODY,n),t.updateMatrix()}},E.prototype.remove=function(t){i.Scene.prototype.remove.call(this,t),t.physics instanceof e&&(delete this.physijs.id_body_map[t.physics._.id],this.physijs.postMessage(X.REMOVE_RIGIDBODY,{body_id:t.physics._.id}))},E.prototype.step=function(i,t,s){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=s;for(var e=Object.keys(this.physijs.id_body_map),n=0;n<e.length;n++){var o=e[n],r=this.physijs.id_body_map[o];null!=r&&(r.position.equals(r.physics._.position)&&r.quaternion.equals(r.physics._.quaternion)||this.physijs.setRigidBodyTransform(r),r.physics.linear_velocity.equals(r.physics._.linear_velocity)||this.physijs.setRigidBodyLinearVelocity(r),r.physics.angular_velocity.equals(r.physics._.angular_velocity)||this.physijs.setRigidBodyAngularVelocity(r),r.physics.linear_factor.equals(r.physics._.linear_factor)||(this.physijs.setRigidBodyLinearFactor(r),r.physics._.linear_factor.copy(r.physics.linear_factor)),r.physics.angular_factor.equals(r.physics._.angular_factor)||(this.physijs.setRigidBodyAngularFactor(r),r.physics._.angular_factor.copy(r.physics.angular_factor)))}this.physijs.postMessage(X.STEP_SIMULATION,{time_delta:i,max_step:t})};var $={PhysicsObject:s,Box:o,Cone:a,Convex:h,Cylinder:_,Plane:l,Sphere:u,TriangleMesh:f,HingeConstraint:b,CompoundObject:m,Scene:E};return $});